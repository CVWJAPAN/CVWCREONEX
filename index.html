<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CVWJAPAN 児童相談AI室（匿名）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #fff; color: #222; font-family: 'Noto Sans JP', sans-serif; margin: 0; }
    .header { background: #19ffe5; color: #fff; padding: 1em; font-size: 1.3em; text-align: center; letter-spacing: 0.1em; }
    .chat { max-width: 500px; margin: 30px auto; border-radius: 16px; box-shadow: 0 0 16px #aaa6, 0 2px 6px #6ff4; padding: 2em; background: #fafbfc; }
    .bubble { margin: 0.7em 0; padding: 0.8em 1em; border-radius: 1.2em; }
    .ai { background: #e7f6fb; align-self: flex-start; }
    .user { background: #ffbef7; align-self: flex-end; text-align: right; }
    .input-area { display: flex; gap: 0.5em; margin-top: 1.5em; }
    input, button { font-size: 1em; border-radius: 8px; border: none; padding: 0.7em; }
    input { flex: 1; border: 1px solid #bbb; }
    button { background: #ff34b1; color: #fff; font-weight: bold; cursor: pointer; }
    .footer { font-size: 0.9em; color: #666; text-align: center; margin: 1em 0; }
    .pdf-btn { background: #19ffe5; color: #fff; margin-top: 1.5em; width: 100%; }
    .policy { font-size: 0.85em; margin-top: 1em; color: #444; background: #faf5e7; padding: 1em; border-radius: 10px; }
  </style>
</head>
<body>
  <div class="header">CVWJAPAN 児童相談AI室（匿名・完全記録非保持）</div>
  <div class="chat" id="chat">
    <div class="ai bubble">こんにちは。ここは匿名の相談室です。あなたの話をなんでも聞かせてください。（※記録はあなたの端末だけ／AIとあなた以外、誰にも見られません）</div>
  </div>
  <div class="chat input-area">
    <input id="userInput" placeholder="相談内容を入力..." autocomplete="off"/>
    <button onclick="sendMsg()">送信</button>
  </div>
  <div class="chat">
    <button class="pdf-btn" onclick="exportPDF()">相談履歴をPDFで保存</button>
    <div class="policy">
      この相談室は完全匿名・記録非保持です。入力された情報は外部サーバーに一切保存されません。PDFはあなたの端末だけに保存できます。<br>
      <b>※危険や命に関わる状況は、すぐ地域の支援先や大人にも相談しましょう。</b>
    </div>
  </div>
  <div class="footer">
    &copy; 2025 一般社団法人CVWJAPAN<br>
    AI：OpenAI GPT-4.1 / 開発：NOBUSHI
  </div>

  <script>
    const API_KEY = "YOUR_OPENAI_API_KEY"; // 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
    const chat = document.getElementById('chat');
    let history = [
      {role: "system", content: "あなたは日本の児童相談室AIです。優しく、親身に、子どもや保護者の気持ちに寄り添い、匿名性と安心感を大切にします。"}
    ];

    function escapeHTML(s) {
      return s.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    async function sendMsg() {
      const input = document.getElementById('userInput');
      const userText = input.value.trim();
      if(!userText) return;
      input.value = '';
      appendMsg('user', userText);
      history.push({role:"user", content: userText});
      // GPT-4o/4.1エンドポイント
      const response = await fetch("https://api.openai.com/v1/chat/completions",{
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization":"Bearer "+API_KEY
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: history,
          max_tokens: 500,
          temperature: 0.7
        })
      });
      const data = await response.json();
      if(data.choices && data.choices.length) {
        const aiMsg = data.choices[0].message.content;
        appendMsg('ai', aiMsg);
        history.push({role:"assistant", content: aiMsg});
      } else {
        appendMsg('ai', "（AI応答が取得できませんでした。しばらくしてからもう一度お試しください）");
      }
    }

    function appendMsg(type, msg) {
      const div = document.createElement('div');
      div.className = type+" bubble";
      div.innerHTML = escapeHTML(msg).replace(/\n/g,"<br>");
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // PDFエクスポート
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      let doc = new jsPDF();
      doc.setFont("NotoSans", "normal");
      doc.setFontSize(14);
      let y = 20;
      doc.text("CVWJAPAN 児童相談AI室 履歴", 10, y);
      y += 10;
      history.forEach(h => {
        let speaker = h.role==="user" ? "あなた：" : h.role==="assistant" ? "AI：" : "";
        if(!speaker) return;
        let lines = doc.splitTextToSize(speaker + h.content, 180);
        lines.forEach(line=>{
          if(y > 270) { doc.addPage(); y=20; }
          doc.text(line, 10, y); y+=8;
        });
      });
      doc.save("jidou_soudan_room.pdf");
    }
  </script>
</body>
</html>
